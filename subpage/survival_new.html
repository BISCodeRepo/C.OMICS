<div id="survivalContent">
  <div class="layerPopup">
    <div class="spinner"></div>
  </div>

  <div class="component-item">
    <h3 class="component-ttl"></h3>
    <div class="white-bd-box search-02-box">
      <div class="box-inner">
        <h3 class="custom-ttl2">Gene name</h3>
        <select id="survival_select-tools" multiple placeholder="Target" style="height: 40px; width:250px;"></select>

        <h3 class="custom-ttl2">Type</h3>
        <select id="survival_type-tools" multiple placeholder="Type" style="height: 40px; width: 150px;"></select>

        <h3 class="custom-ttl2">P-value (range: 0~1)</h3>

        <input id="pvalue-start" type="number" class="survival-number-input" step="0.0001" min="0.0000" max = "1.0000" title="Enter a number between 0 and 1." value="0.0000"/> ~
        <input id="pvalue-end" type="number" class="survival-number-input" step="0.0001" min="0.0000" max = "1.0000" title="Enter a number between 0 and 1." value="1.0000"/>

        <button type="button" class="green-btn" id="survival_apply-btn">Apply</button>

        <h3 class="custom-ttl2" style="margin-left: 20px;">P-value sorting</h3>

       <!--<select id="survival_select-tools2" style="height: 40px;width:140px;"></select>--> 

        <button type="button" class="ico-btn" id="survival_sort-icon">
          <span class="txt-hidden">필터</span>
          <img src="subpage/images/ico-arrows-down-up.svg" alt="필터 아이콘" class="ico">
        </button>
      </div>
    </div>
  </div>
  <h4 class="component-ttl"></h4>

  <div id="survival_main_task_div" style="width: 95%; margin: auto;">
    <div id="survival_geneName_list" style="width:17%;height:76vh;overflow: auto;float:left;margin-right:1%;">
      <div class="panel panel-info">
        <div class="panel-heading">
          <h3 class="panel-title">Gene name</h3>
        </div>
        <ul class="list-group" id="geneNameListUl"> </ul>
      </div>
    </div>

    <div class="survival_container1"> </div>
  </div>
  

</div>


<script type="text/javascript">

    var allPvalueList = [];
    var overallList = [];
    var sur_allPatient = new Map();
    var sur_proteinPatient = []
    var sur_genePatient = []
    var sur_acetlysitePatient = []
    var sur_phosphositePatient = []
    var sur_allProtein = new Map();
    var sur_allGene = new Map();
    var sur_allAcetlysite = new Map();
    var sur_allPhosphosite = new Map();
    var sur_patientInfo = [];
    var sur_targetOptions = []
    var sur_sortOrder = 0
    var subPavlueList = [];

    var sur_index = 1
    var sur_sort_value = 0
    var sur_result_array = []
    var sur_processed = 0
    var sur_prev_protein = ''
    var sur_sort_type = 0
    //var sortOptions = [];
    var container = document.getElementsByClassName('survival_container1');

    $(function(){

        $.ajax({
            type:"GET",   
            url: "../file/Overall_survivals.csv",
            data:[],  
            dataType:"text",
            cache:false,
            success:function(data){  
                overallList = data.split('\n');
            }
        });  

        $.ajax({
            type:"GET",   
            url: "../file/tmp.csv",
            data:[],  
            dataType:"text",
            cache:false,
            success:function(data){  
                allPvalueList = data.split('\n');
            }
        }); 

        getSurvivalData();

        //apply button event
        $('#survival_apply-btn').click(function () {

            sur_sortOrder = 0
            survivalClickEvent();
        });


        //sorting button event
        $('#survival_sort-icon').click(function () {

            if(sur_sortOrder == 0){
                sur_sortOrder = 1
            } else{
                sur_sortOrder = 0
            }
            survivalClickEvent();
        });

        $('#survival_geneName_list').css('display','none');

    });


    function survivalClickEvent(){

        const targetValue = $('#survival_select-tools').text();
        const typeValue = $('#survival_type-tools').text();
        const pvalueStart = $('#pvalue-start').val();
        const pvalueEnd = $('#pvalue-end').val();

        if(isEmpty(targetValue) && isEmpty(pvalueStart) && isEmpty(pvalueEnd)){
            alert("Select the gene name or enter the P-value range value!");
            return;
        }

        if(!isEmpty(pvalueStart) || !isEmpty(pvalueEnd)){
            if(pvalueStart < 0 || pvalueStart > 1){
                alert("Enter a number between 0 and 1.");
                return;
            }

            if(pvalueEnd < 0 || pvalueEnd > 1){
                alert("Enter a number between 0 and 1.");
                return;
            }

            if(pvalueStart > pvalueEnd){
                alert("The first value must be smaller than the second value.");
                return;
            }
            
        }

        if(isEmpty(targetValue) && pvalueStart==0 && pvalueEnd==1){
            alert("Select the gene name when selecting the entire p-value range!");
            return;
        }


        getSurvivalGeneNameList(targetValue,pvalueStart,pvalueEnd,typeValue);
    }

    function getSurvivalGeneNameList(targetValue,pvalueStart,pvalueEnd,typeValue){

        $('#survival_geneName_list').css('display','block');
        //debugger
        subPavlueList = [];
        var tmpList = []
        if(!isEmpty(targetValue)){ // target is existed
            tmpList = allPvalueList.filter((value, index, self) => {
                return index>0 && (value.trimEnd().split(",")[1]!="RNA"? value.trimEnd().split(",")[0].split('_')[0]==targetValue:value.trimEnd().split(",")[0] == targetValue)
                && value.trimEnd().split(",")[2]<=pvalueEnd && value.trimEnd().split(",")[2]>=pvalueStart;
              });
        } else { //target is null
            tmpList = allPvalueList.filter((value, index, self) => {
                return index>0 && value.trimEnd().split(",")[2]<=pvalueEnd && value.trimEnd().split(",")[2]>=pvalueStart;
              });
            
        }
        if(!isEmpty(typeValue)){ //Type is existed
            $.each(tmpList,function(n,v){
                var tmp = v.trimEnd().split(",");
                if(tmp[1]==typeValue){
                    subPavlueList.putsh(v.trimEnd());
                }

            });
        } else { // Type is null
            subPavlueList = tmpList
        }
        
        drawGeneTable(subPavlueList);
    }

    function drawGeneTable(subPavlueList){

        $('#geneNameListUl').empty();
        
        var liSet = new Set()
        for (var i = 1; i < subPavlueList.length; i++) {
            var tmp = subPavlueList[i].trimEnd().split(',');
            if(tmp[1]!="RNA"){
                liSet.add(tmp[0].split('_')[0]);
            } else{
                liSet.add(tmp[0]);
            }   
        }
        var liList = Array.from(liSet).sort();

        var listr="";
        for(var i=0; i<liList.length; i++){
            var tmp = liList[i].split(',');
            listr+="<li class='list-group-item' name='"+tmp[0]+"' onclick='genenNameClick(this);'><a href='#'>"+tmp[0]+"</a></li>";
        }

        $('#geneNameListUl').append(listr);
    }


    //click gene name list
    function genenNameClick(e){
        
        debugger
        var geneName = $(e).attr('name');
        var drawList = []
        subPavlueList
        drawSurvivalPlot(drawList)
    }


    function drawSurvivalPlot(drawList){
        var layout = {
            title : {
                text : title+ "<br>P-value = " + p_val,
            },
           yaxis:{
                autotick: false,
                ticks: 'outside',
                tick0: 0,
                dtick: 0.25,
                range : [0,1]
            },
          xaxis :{
            title :'month'
          },
          legend: {
            autosize : false,
            font: {size: 16},
            yref: 'paper',
            title : p_val
          }
        };
        trace1 = {
            x: kmsurv_high.map((item) => item.t_i*12),
            y: kmsurv_high.map((item) => item.S_t),
            mode: 'lines',
            name: 'high',
            
            line: {shape: 'hv', color: 'red'},
        };
        
        trace2 = {
            x: kmsurv_low.map((item) => item.t_i*12),
            y: kmsurv_low.map((item) => item.S_t),
            mode: 'lines',
            name: 'low',
            
            line: {shape: 'hv', color: 'blue'},
        };
        
        trace3 = {
            x: censor_low.map((item) => item.c_t*12),
            y: censor_low.map((item) => item.c_s),
            mode: 'markers',
            
            marker: { size: 6, color: 'blue', symbol : 142 },
            showlegend :false
        }
        
        trace4 = {
            x: censor_high.map((item) => item.c_t*12),
            y: censor_high.map((item) => item.c_s),
            mode: 'markers',
            marker: { size: 6, color: 'red', symbol : 142 },
            showlegend :false
        }
          

    }

    function isEmpty(val){
        if(val==null || val ==""){
            return true
        }
        return false
    }


    function getSurvivalData() {

      var surAllData = allData

      showSpinner('survivalContent');

      var geneTmp = getSurvivalGeneList(surAllData);
 
      $.each(geneTmp,function(n,value) {
        sur_targetOptions.push({id:value,title:value})
      });

      var $select = $('#survival_select-tools').selectize({
        plugins: ["remove_button"],
        maxItems: 1,
        maxOptions: 100,
        valueField: 'id',
        labelField: 'title',
        searchField: 'title',
        options: sur_targetOptions,
        create: false,
      });
  
      var $select3 = $('#survival_type-tools').selectize({
        plugins: ["remove_button"],
        maxItems: 1,
        maxOptions: 4,
        valueField: 'id',
        labelField: 'title',
        searchField: 'title',
        options: [{id:'RNA',title:'RNA'},{id:'PROTEIN',title:'Protein'},
                  {id:'ACETYL',title:'Acetylsite'},{id:'PHOSPHO',title:'Phosphosite'}],
        create: false
      });

      const patientData = metaArray;
      const rowHeader = [];
      patientData.map((row) => {
        const rowData = row.split(",");
        rowHeader.push(rowData[0]);
        let uniqueValue = unique(rowData.slice(1));       
      });

      //get sur_patientInfo
      for (let i = 1; i < patientData[0].split(",").length; i++) {
        sur_patientInfo.push(new PatientMetaData());
      }
      for (let i = 0; i < rowHeader.length; i++) {
        let row = patientData[i].split(",").slice(1)
        for (let j = 0; j < row.length; j++) {
          sur_patientInfo[j][rowHeader[i]] = row[j];
        }
      }
      sur_patientInfo.forEach((value) => {
        sur_allPatient.set(value['Sample ID'], value)
      });
      //console.log(sur_allPatient)

      //separate data by type(protein,rna,acetyl,phospho)

      //protein
      var sur_proteinAllData = []
      
      $.each(surAllData,function(n,v){
        var tmp = v.split(",");
        if(n==0){
          sur_proteinAllData.push(v)
        }
        
        if(tmp[0] == 'PROTEIN'){
          sur_proteinAllData.push(v)
        }
      });

      sur_proteinPatient = sur_proteinAllData[0].trimEnd().split(",").slice(4);

      for (let i = 1; i < sur_proteinAllData.length; i++) {
        const row = sur_proteinAllData[i].trimEnd().split(",")
        sur_allProtein.set(row[2]+'_'+row[1], row.slice(4))
        //sur_allProtein.set(row[1], row.slice(4))
      }

      //acetyl
      var sur_acetylAllData = []
      
      $.each(surAllData,function(n,v){
        var tmp = v.split(",");
        if(n==0){
          sur_acetylAllData.push(v)
        }
        
        if(tmp[0] == 'ACETYL'){
          sur_acetylAllData.push(v)
        }
      });

      sur_acetlysitePatient = sur_acetylAllData[0].trimEnd().split(",").slice(4);

      for (let i = 1; i < sur_acetylAllData.length; i++) {
        const row = sur_acetylAllData[i].trimEnd().split(",")
        sur_allAcetlysite.set(row[1], row.slice(4))
        sur_allAcetlysite.set(row[3], row.slice(4))
      }

      //phospho
      var sur_phosphoAllData = []
      
      $.each(surAllData,function(n,v){
        var tmp = v.split(",");
        if(n==0){
          sur_phosphoAllData.push(v)
        }
        
        if(tmp[0] == 'PHOSPHO'){
          sur_phosphoAllData.push(v)
        }
      });

      sur_phosphositePatient = sur_phosphoAllData[0].trimEnd().split(",").slice(4);

      for (let i = 1; i < sur_phosphoAllData.length; i++) {
        const row = sur_phosphoAllData[i].trimEnd().split(",")
        sur_allPhosphosite.set(row[1], row.slice(4))
        sur_allPhosphosite.set(row[3], row.slice(4))
      }

      //rna

      var sur_geneAllData = []
      
      $.each(surAllData,function(n,v){
        var tmp = v.split(",");
        if(n==0){
          sur_geneAllData.push(v)
        }
        
        if(tmp[0] == 'RNA'){
          sur_geneAllData.push(v)
        }
      });

      sur_genePatient = sur_geneAllData[0].trimEnd().split(",").slice(4);

      for (let i = 1; i < sur_geneAllData.length; i++) {
        const row = sur_geneAllData[i].trimEnd().split(",")
        sur_allGene.set(row[2], row.slice(4))
      }

      hideSpinner('survivalContent')

    }

    function getSurvivalGeneList(nmfData){
 
      var geneList = []
     
      //Genens
      for(var i = 1; i<nmfData.length-1;i++) {
          var tmp = nmfData[i]
          geneList.push(tmp.split(',')[3].split("_")[0])
      }
     
      let patSet = new Set(geneList);
      geneList = Array.from(patSet).sort();
     
      return geneList
     
    }


    function unique(array) {
      return array.filter((value, sur_index, self) => {
        return value !== 'None' && value !== '' && self.indexOf(value) === sur_index;
      });
    }

</script>