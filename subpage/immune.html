<div id="ImmuneContent">
  <div class="layerPopup">
    <div class="spinner"></div>
  </div>
  <div class="component-item">
    <h3 class="component-ttl"></h3>
    <div class="white-bd-box search-01-box">
      <h3 class="custom-ttl">Genes of intereset (max, 10)</h3>
      <div class="" style="width: 100%;max-height: 150px;">
        <input type="text" id="ImmuneGenesOpt" data-width="95%" name="nmfGenesSelect" value="CSNK2A1,KRAS,ERBB2,XPO1,TP53,EGFR"/>
      </div>
      <div class="box-btn-wrap">
        <button type="button" class="green-btn" id="ImmuneSelectBtn">Apply</button>
      </div>
    </div>
  </div>
  <div id="ImmuneHeatmapDiv" style="width:95%;margin:auto;"> </div>

  <div class="ImmuneContainer">
    <div class="legend-box-area">
      <div id="ImmuneFloatContainerBtn" class="legend-box-before active">
        <h6 class="custom-ttp">Legend</h6>
      </div>

      <div id="immnun-legend-after" class="legend-box-after">
        <div class="box-top">
          <h3 class="custom-ttp">Legend</h3>

          <button id="ImmuneFloatContainerRemoveBtn" type="button" class="ico-btn">
            <span class="txt-hidden">닫기</span>
            <img src="subpage/images/ico-x.svg" alt="닫기 아이콘" class="ico">
          </button>
        </div>
        <div id="ImmuneFloatContainer" style="font-size: 10px;background: #fbfffe; overflow: auto;height:30rem;"></div>
    </div>
  </div>
</div>

<style type="text/css">
  .ImmuneContainer{
    width: 0px;border-radius: 0 15px 15px 0;height: 25rem;
    background: #f2f5fb;position: absolute; top: 31.5rem;right: 5rem;z-index: 999;
  }
</style>

<script type="text/javascript">

var patientsArray = []
var uniprotIdArray = []
var dataArray = []
var geneList = []
var selectizeElement = null;
var ImmuneData =[]
var immunMorpheus = null;
var linkArray =[] 
var subGenArray = []

  $(function() {

    showSpinner();

    $('#ImmuneFloatContainerBtn').click(function(){

      $(this).removeClass('active');
      $('#immnun-legend-after').addClass('active');

      $('.ImmuneContainer').css({right:'0px'});
      $('.ImmuneContainer').css({width:'24rem'});
      $(".ImmuneContainer").css("z-index","auto");
      ImmunLayer();
     });

    $('#ImmuneFloatContainerRemoveBtn').click(function(){
      $('#ImmuneFloatContainer').empty();
      $('.ImmuneContainer').css({width:'0px'});
      $('.ImmuneContainer').css({right:'5rem'});
      $(".ImmuneContainer").css("z-index","999");
      $('#ImmuneFloatContainerBtn').addClass('active');
      $('#immnun-legend-after').removeClass('active');
    });

    $.ajax({
      type:"GET",    
      url: "../file/Immune.csv", 
      //url: "http://127.0.0.1:5501"+"/file/Immune.csv", 
      data:[],   
      dataType:"text", 
      cache:false, 
      success:function(data){   
        //debugger
        ImmuneData = data.split('\n');
        
      }
    });

    $.ajax({
    type:"GET",    
    url: "../file/tumer_nmf_all.csv", 
    data:[],   
    dataType:"text", 
    cache:false, 
    success:function(data){   
      //debugger
      nmfData = data.split('\n');
      //load nmf data
      getNmfData(nmfData)
      // getNmfData(ImmuneData)

      hideSpinner()
    }
    });

    $('#ImmuneSelectBtn').click(function(){

      var subDataArray=[]
      var subUniprotArray=[]
      var tmpuniprotIdArray = $('#ImmuneGenesOpt').val().split(',');
      var subLinkArray = []
      //debugger
      var subGenList = []
      if(tmpuniprotIdArray.length == 0 || tmpuniprotIdArray[0] == ''){
        tmpuniprotIdArray = ["CSNK2A1","KRAS","ERBB2","XPO1","TP53","EGFR"];
        var control = selectizeElement[0].selectize;
        control.setValue(["CSNK2A1","KRAS","ERBB2","XPO1","TP53","EGFR"]);
      } 

      for(var i = 0; i<tmpuniprotIdArray.length;i++){
          $.each(uniprotIdArray,function(n,v){
            if(v.indexOf("_")>-1 && v.split("_")[0] == tmpuniprotIdArray[i]){
              subGenList.push(n);
              subUniprotArray.push(v);
              $.each(linkArray,function(m,y){
                if(v==y.split('=')[0]){
                  subLinkArray.push(y.split('=')[1]);
                  return;
                }
              })
            } else if(v.indexOf("_")==-1 && v == tmpuniprotIdArray[i]){
              subGenList.push(n);
              subUniprotArray.push(v);
              $.each(linkArray,function(m,y){
                if(v==y.split('=')[0]){
                  subLinkArray.push(y.split('=')[1]);
                  return;
                }
              })
            }
          })
      }

      subGenArray = subUniprotArray

      for(var i = 0; i<subGenList.length;i++){
        var rowIdx = subGenList[i]
        subDataArray.push(dataArray[rowIdx])
      }

      immunMorpheus = paintHeatMap(subUniprotArray,patientsArray,subDataArray,'ImmuneHeatmapDiv',ImmuneData,subLinkArray)
    });


    $('#legendBtn').click(function(){
      var colorMap = immunMorpheus.project.columnColorModel.vectorNameToColorMap.map;
      ImmuneDrawLegendPopup(colorMap);
    });

    $('#helpBtn').click(function(){
      alert("개발중....")
    });

    $('#ImmuneHeatmapDiv').mouseup(function(event){
      if(event.currentTarget.className == 'morpheus'){
        if ( immunMorpheus.selectedRowTrackName == 'Link' && ((event.button == 0) || (event.which == 1))) {
          var index = immunMorpheus.project.hoverRowIndex
          var gene = subGenArray[index]
          var link = ""
          $.each(linkArray,function(m,y){
            if(gene==y.split('=')[0]){
              link = y.split('=')[1]
              return;
            }
          });
          if(link!='X'){
            window.open('https://www.uniprot.org/uniprotkb/'+link+'/entry', '_blank');
          }
        }

        immunMorpheus.selectedRowTrackName = ''
      }
    })

  });

  function ImmunLayer(){
    //debugger;
    var colorMap = immunMorpheus.project.columnColorModel.vectorNameToColorMap.map;
    var htmlStr="<table style='font-size: 11px;border-style: solid;border-width:1px;border-color: #e5efe9;'><tr>";
      var substr="";
      var i = 1;
      //debugger;
      $.map(colorMap, function(k, v){
        if(k.key !="Sample.ID"){
          var colo = immuneMetaGradientName[k.key];
          var newArr = $.map(k.value,function(key,value){return key});
          var subArr = $.map(newArr[0],function(key,value){return key});
          
          if(colo==null || colo=="" || colo==undefined){
            htmlStr += "<td style='text-align: center;'>"+k.key+"</td>";
            substr += "<td style='height: fit-content;'><div style='height: 5px;'></div><table border='1px solid #ccc' cellspacing='0' cellpadding='0' style='margin: auto;font-size: 11px;'>";
            $.map(subArr,function(key,value){        
              substr += "<tr><td bgcolor='"+key.value+"' height='15' width='15'></td>"+
                "<td>"+key.key+"</td></tr>";
            });
            substr += "</table><div style='height: 5px;'></div></td>";

            if(i%1==0){
              htmlStr += substr;
              htmlStr +="</tr><tr>";
              substr = "";
            }
            i++;
          }
        }
      });
      htmlStr += substr;
      htmlStr += "</tr><tr>";

      htmlStr += "<td style='text-align: center;'>Cell type enrichment score</td>";
      htmlStr += "<td style='height: fit-content;'>" +
        "<table border='1px solid #ccc' cellspacing='0' cellpadding='0' style='margin: auto;font-size: 10px;'>"+
          "<tr><td>"+
            "<div><div style='height:20px;width:49px;margin:auto; background : linear-gradient(to right,#0000FF,#FFFFFF);float:left'></div>"+
            "<div style='height:20px;width:49px;margin:auto; background : linear-gradient(to right,#FFFFFF,#ff0000);float:right'></div></div>"+
          "</td></tr>"+
          "<tr><td>"+
            "<div style='float: left;margin-left:2px'>-4</div><div style='float:left;margin-left: 35px;'>0</div>"+
            "<div style='float:right;margin-right:2px'>4</div>"+
          "</td></tr></table>"+
        "<div style='height: 5px;'></div></td></tr>" ;

      htmlStr += "<tr>" + "<td style='text-align: center;'>Pathway enrichment score</td>"
      htmlStr += "<td style='height: fit-content;'>" +
        "<table border='1px solid #ccc' cellspacing='0' cellpadding='0' style='margin: auto;font-size: 10px;'>"+
          "<tr><td>"+
            "<div style='height:20px;width:98px;margin:auto; background : linear-gradient(to right,#FFFFFF,#ff0000);'></div>"+
          "</td></tr>"+
          "<tr><td>"+
            "<div style='float: left;margin-left:2px'>0</div><div style='float:left;margin-left: 38px;'>3</div>"+
            "<div style='float:right;margin-right:2px'>6</div>"+
          "</td></tr></table>"+
        "<div style='height: 5px;'></div></td></tr>" ;

      htmlStr += "</table><div style='height: 5px;'></div>";

    $('#ImmuneFloatContainer').append(htmlStr);
    
  }


  function getNmfData(nmfData){

    //debugger;
    //Patients
    patientsArray = getConcatSampleList();
    
    //GeneIDs
    dataArray = getDataArray();
    uniprotIdArray = getRowGeneList();

    //Genes
    var geneTmp = getConcatGeneList();

    linkArray = getUniprotIDList(uniprotIdArray);

    $.each(geneTmp,function(n,value) { 
      geneList.push({id:value,title:value})
    });

    selectizeElement = $('#ImmuneGenesOpt').selectize({
      plugins: ["remove_button"],
      maxItems: 10,
      maxOptions: 100,
      valueField: 'id',
      labelField: 'title',
      searchField: 'title',
      sortField: 'title',
      options: geneList,
      create: false
    });

    var tmpuniprotIdArray = $('#ImmuneGenesOpt').val().split(',');
    var subUniprotArray=[]

    var subGenList = []
    var subLinkArray = []
   
    for(var i = 0; i<tmpuniprotIdArray.length;i++){
      $.each(uniprotIdArray,function(n,v){
        if(v.indexOf("_")>-1 && v.split("_")[0] == tmpuniprotIdArray[i]){
          subGenList.push(n);
          subUniprotArray.push(v);
          $.each(linkArray,function(m,y){
            if(v==y.split('=')[0]){
              subLinkArray.push(y.split('=')[1]);
              return;
            }
          })
        } else if(v.indexOf("_")==-1 && v == tmpuniprotIdArray[i]){
          subGenList.push(n);
          subUniprotArray.push(v);
          $.each(linkArray,function(m,y){
            if(v==y.split('=')[0]){
              subLinkArray.push(y.split('=')[1]);
              return;
            }
          })
        }
      })
    }

    subGenArray = subUniprotArray

    var subDataArray = []
    for(var i = 0; i<subGenList.length;i++){
      var rowIdx = subGenList[i]
      subDataArray.push(dataArray[rowIdx])
    }

    immunMorpheus = paintHeatMap(subUniprotArray,patientsArray,subDataArray,'ImmuneHeatmapDiv',ImmuneData,subLinkArray)
  }


</script>