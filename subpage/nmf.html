<div id="nmfContent">
    <div class="layerPopup">
      <div class="spinner"></div>
    </div>
    <div id = "select_menu" style="width:95%;margin:auto">
        <table id="selectTable" class = "table table-bordered table-hover table-striped">
          <thead>
            <tr class="active">
                <th class="th-text-align" style="width: 20%;">
                    Genes of interest (max. 10)
                </th>
                <th>
                  <div class="control-group" style="width: 95%;">
                    <input type="text" id="nmfGenesOpt" data-width="95%" name="nmfGenesSelect" value="EGFR,EGFR-AS1,TP53"/>
                  </div>
                </th>
                <th style="width: 7%;">
                    <div class="btn-toolbar">
                        <input type="button" id="selectBtn" class="btn btn-primary" value="Apply" style="width: 90%;margin-right:5px;"/>
                    </div>
                </th>
            </tr>
          </thead>
        </table>
      </div>
      <div style="height: 10px;"></div>
      <div id="heatmapDiv" style="width:95%;margin:auto;" class="morpheus html-widget"> </div>
    </div>
    <script type="text/javascript">
    
    var patientsArray = []
    var uniprotIdArray = []
    var dataArray = []
    var geneList = []
    var metaRevert = []
    var metaArray = []
    
      $(function() {
    
        showSpinner();

        $.ajax({
          type:"GET",    
          url: baseURL+"file/NMF_meta.csv", 
          data:[],   
          dataType:"text",  
          cache:false,
          success:function(data){   
            //debugger
            var dataList = data.split('\n')
            metaArray = dataList
          }
        });
        
        $.ajax({
          type:"GET",    
          url: baseURL+"file/Quantitation_genes.csv", 
          data:[],   
          dataType:"text", 
          cache:false, 
          success:function(data){   
            //debugger
            var dataList = data.split('\n')
            //Patients
            var pat = dataList[0].substr(0,dataList[0].length-1);
            patientsArray = pat.split(',').slice(1,pat.split(',').length)
            //UniProtID
            for(var i = 1; i<dataList.length;i++) {
              var tmp = dataList[i]
              uniprotIdArray.push(tmp.split(',')[0])
              dataArray.push(tmp.split(',').slice(1, tmp.split(',').length))
            }
    
            var geneTmp = Array.from(new Set(uniprotIdArray)).sort();
            $.each(geneTmp,function(n,value) { 
              geneList.push({id:value,title:value})
            });
            //EGFR,TP53
            $('#nmfGenesOpt').selectize({
              plugins: ["remove_button"],
              maxItems: 10,
              maxOptions: 100,
              valueField: 'id',
              labelField: 'title',
              searchField: 'title',
              sortField: 'title',
              options: geneList,
              create: false
            });
    
            var tmpuniprotIdArray = $('#nmfGenesOpt').val().split(',') //['EGFR','EGFR-AS1','TP53']
    
            paintHeatMap(tmpuniprotIdArray,patientsArray,dataArray,true)
          }
        });

        
        $('#selectBtn').click(function(){
    
          var subGeneArray = []
          var subGeneSelect =[]
          var subUniprotIdArray = []
    
          var subDataArray=[]
    
    
          debugger;
          if($('#nmfGenesOpt').val()!=null && $('#nmfGenesOpt').val()!=''){
            subGeneSelect = $('#nmfGenesOpt').val().split(',');
            $.each(subGeneSelect,function(n,v){
              for(var i = 0; i<uniprotIdArray.length;i++) {
                var tmp = uniprotIdArray[i]
                if(tmp==v){
                  subUniprotIdArray.push(tmp)
                  subGeneArray.push(i)
                }
              }
            })
          } else{
            subUniprotIdArray = uniprotIdArray
            for(var i = 0; i<uniprotIdArray.length;i++) {
                  subGeneArray.push(i)
            }
          }

          for(var i = 0; i<subGeneArray.length;i++){
            var rowIdx = subGeneArray[i]
            tmpArray.push(dataArray[rowIdx])
            subDataArray.push(tmpArray)
          }
    
            paintHeatMap(subUniprotIdArray,subPatientsArray,subDataArray,false)
        });
    
      });
    
    
    
      function paintHeatMap(uniprotIdArray,patientsArray,dataArray,ifMain){
          debugger;
    
          var patientTmp = []
    
          for(var i=0; i<metaArray.length; i++){
            var tmp = metaArray[i].substr(0,metaArray[i].length-1);
            var tmpArray = tmp.split(',').slice(1,tmp.split(',').length)
            
            for(var j=0; j<patientsArray.length;j++){
              if(tmpArray.indexOf(patientsArray[j])>-1){
                patientTmp.push(tmpArray.indexOf(patientsArray[j]))
              }
            }
          }
    
          var metaList = []
          for(var i=0; i<metaArray.length; i++){
            var tmp = metaArray[i].substr(0,metaArray[i].length-1);
            var colValue = tmp.split(',')[0];
            var tmpArray = tmp.split(',').slice(1,tmp.split(',').length)
            var putArray =[];
            for(var j=0;j<patientTmp.length;j++){
              putArray.push(tmpArray[patientTmp[j]]);
            }
            metaList.push({
                  'name':colValue,
                  'array':putArray
            })
            if(ifMain){
              let set = new Set(tmpArray);
              nmfMetaDataJson[colValue] = Array.from(set).sort()
            }
          }
    
          nmfMetaObj['vectors'] = metaList
    
          $('#heatmapDiv').empty();
          var json = {
            "rows": uniprotIdArray.length,
            "columns": patientsArray.length,
            "seriesArrays": [dataArray],
            "seriesDataTypes": ["Float32"],
            "seriesNames": ["NMF"],
            "rowMetadataModel": {
              "vectors": [{
                "name": "Gene",
                "array": uniprotIdArray
              }]
            },
            "columnMetadataModel": nmfMetaObj
          }
    
          new morpheus.HeatMap({
            el: $('#heatmapDiv'),
            dataset: morpheus.Dataset.fromJSON(json),
            colorScheme: { // optional color scheme. default is relative
              type: 'fixed',
              map: [{
                value: 2000,
                color: '#0000ff'
              }, {
                value: 1000,
                color: '#ffffff'
              }, {
                value: 0,
                color: '#ff0000'
              }]
            },
            tools: [{ // optional tools to run at load time
              //name: 'Hierarchical Clustering',
              //params: {cluster: 'Rows and columns'}
            }]
          });
    
          hideSpinner()
        }
    
    </script>