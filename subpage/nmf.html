<div id="nmfContent">
<div id = "select_menu" style="width:90%;height:170px;margin:auto">
    <table id="selectTable" class = "table table-bordered table-hover table-striped">
      <thead>
        <tr class="active">
            <th style="width: 20%;">
                Genes of interest (max. 10)
            </th>
            <th>
                <input type="text" id="nmfGenesTxt" class="form-control" data-width="95%" name="nmfGenesInput"/>
            </th>
            <th rowspan="3" style="width: 10%;">
                <div class="btn-toolbar" style="margin:auto">
                    <input type="button" id="selectBtn" class="btn btn-default" value="Apply" style="width:150px;height:150px"/>
                </div>
            </th>
        </tr>
      <tr class="active">
        <th>
            Sort by
        </th>
        <th>
            <select id = 'nmfSortOpt' name="nmfSortSelect" class="form-control selectpicker"
                    data-live-search="false" data-width="95%"  multiple></select>
        </th>
      </tr>
      <tr class="active">
        <th>
            Column by
        </th>
        <th>
            <select id = 'nmfColumnOpt' name="nmfColumnSelect" class="form-control selectpicker"
                      data-live-search="false" data-width="95%"  multiple></select>
        </th>
      </tr>
      </thead>
    </table>
  </div>
  <div style="height: 10px;"></div>
  <div id="heatmapDiv" style="width:95%;margin:auto" class="morpheus html-widget"> </div>
</div>
<script>
    $(function() {

        for(var i=0; i<nmfMetaData.length;i++){
            $('#nmfSortOpt').append("<option value='"+nmfMetaData[i]+"' class='dropdown'>"+nmfMetaData[i] +"</option>");
            $('#nmfColumnOpt').append("<option value='"+nmfMetaData[i]+" class='dropdown'>"+nmfMetaData[i] +"</option>");
        }

        $("#nmfSortOpt").selectpicker('refresh');
        $("#nmfColumnOpt").selectpicker('refresh');

        $('.dropdown').mouseover(function () {

            $('#nmfSortSubOptDiv').removeClass('hide');
            $("#nmfSortSubOptDiv").addClass('show');

        }).mouseout(function () { 
            $('#nmfSortSubOptDiv').removeClass('show');
            $('#nmfSortSubOptDiv').addClass('hide');
        });

        /*$('#nmfColumnOpt').on("change", function () {
            var selectedValue = $('select#nmfColumnOpt option:selected').text();
            document.getElementById("nmfColumnOpt").options.length = 0;

            selectOptionChange(selectedValue);
         
        });*/

      var patientsArray = []
      var uniprotIdArray = []
      var dataArray = []
      var genSet = new Set()
      var tmp = ["서울","부산","대구","광주","울산"]
  
      $.ajax({
        type:"GET",    
        url:"http://127.0.0.1:5500/Quantitation_genes.csv", 
        data:[],   
        dataType:"html",  
        success:function(data){   
          var dataList = data.split('\n')
          nmfData = dataList
          //Patients
          patientsArray = dataList[0].split(',').slice(1,dataList[0].split(',').length)
          debugger;
          //UniProtID
          for(var i = 1; i<dataList.length;i++) {
            var tmp = dataList[i]
            uniprotIdArray.push(tmp.split(',')[0])
            genSet.add(tmp.split(',')[0])
            dataArray.push(tmp.split(',').slice(1, tmp.split(',').length))
          }

          paintHeatMap(uniprotIdArray,patientsArray,dataArray)
        }
      });
    
      $('#nmfGenesTxt').autocomplete({ 
          source : tmp, 
          select : function(event, ui) { 
              console.log(ui.item);
          },
          focus : function(event, ui) { 
              return false;
          },
          minLength : 1, 
          autoFocus : true, 
          classes : {
              'ui-autocomplete' : 'highlight'
          },
          delay : 1000, 
          disable : false, 
          limit:10,
          position : { my : 'right top', at : 'right bottom'}, 
          close : function(event) { 
              console.log(event);
          }
      });
  
      $('#selectBtn').click(function(){
  
        var subPatientsSelect = []
        var subPatientsArray = []
        var subUniProtIdSelect = []
        var subUniProtIdArray = []
        var subDataArray=[]
  
        $("#patientsOpt option:selected").each(function () {
          var tmp = $(this).val()
          subPatientsSelect.push(tmp.split('_')[0])
          subPatientsArray.push(tmp.split('_')[1])
        })
  
        $("#uniProtIdOpt option:selected").each(function () {
          var tmp = $(this).val()
          subUniProtIdSelect.push(tmp.split('_')[0])
          subUniProtIdArray.push(tmp.split('_')[1])
        })
        for(var i = 0; i<subUniProtIdSelect.length;i++){
          var rowIdx = subUniProtIdSelect[i]
          var tmpArray = []
          for(var j = 0; j<subPatientsSelect.length;j++){
            var columnIdx = subPatientsSelect[j]
            tmpArray.push(dataArray[rowIdx][columnIdx])
          }
          subDataArray.push(tmpArray)
        }
  
        $('#heatmapDiv').empty()
  
        paintHeatMap(subUniProtIdArray,subPatientsArray,subDataArray)
      });
  
  
      function paintHeatMap(uniprotIdArray,patientsArray,dataArray){
  
        var json = {
          "rows": uniprotIdArray.length,
          "columns": patientsArray.length,
          "seriesArrays": [dataArray],
          "seriesDataTypes": ["Float32"],
          "seriesNames": ["NMF"],
          "rowMetadataModel": {
            "vectors": [{
              "name": "Gene",
              "array": uniprotIdArray
            }]
          },
          "columnMetadataModel": {
            "vectors": [{
              "name": "Sample.ID",
              "array": patientsArray
            }]
          }
        }
  
        new morpheus.HeatMap({
          el: $('#heatmapDiv'),
          dataset: morpheus.Dataset.fromJSON(json),
          colorScheme: { // optional color scheme. default is relative
            type: 'fixed',
            map: [{
                value: 100,
                color: '#009000'
              },{
              value: 500,
              color: '#0000ff'
            }, {
              value: 0,
              color: '#ffffff'
            }, {
              value: 1000,
              color: '#ff0000'
            }]
          },
          tools: [{ // optional tools to run at load time
            name: 'Hierarchical Clustering',
            params: {cluster: 'Rows and columns'}
          }]
        });
      }
    });
  </script>