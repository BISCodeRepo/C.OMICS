  <div id="acetylsiteContent">

    <div class="layerPopup">
      <div class="spinner"></div>
    </div>

    <div id="aceHeatmapDiv" style="width: 95%;margin: auto;"></div>
    <div class="acetylContainer">
      <div class="legend-box-area">
        <div id="acetylFloatContainerBtn" class="legend-box-before">
          <h6 class="custom-ttp">Legend</h6>
        </div>
  
        <div id="acetyl-legend-after" class="legend-box-after">
          <div class="box-top">
            <h3 class="custom-ttp">Legend</h3>
  
            <button id="acetylFloatContainerRemoveBtn" type="button" class="ico-btn">
              <span class="txt-hidden">닫기</span>
              <img src="subpage/images/ico-x.svg" alt="닫기 아이콘" class="ico">
            </button>
          </div>
          <div id="acetylFloatContainer" style="font-size: 10px;background: #fbfffe; overflow: auto;height:18.5rem;"></div>
      </div>
    </div>
  </div>
  <style type="text/css">
    .acetylContainer{
      width:0px;border-radius: 0 15px 15px 0;height: 25rem;
      background: #f2f5fb;position: absolute; top: 130px;right: 5rem;z-index: 999;
    }
  </style>
  <script type="text/javascript">

    var acetyl_matrix = []
    var acetyl_rowHeader = []
    var acetyl_link = []
    var acetyl_metaData = []
    var acetyl_patientData = []
    var acetylsiteMorpheus=null;

    showSpinner('acetylsiteContent');

    $('#acetyl-legend-after').addClass('active');

    $('.acetylContainer').css({right:'0px'});
    $('.acetylContainer').css({width:'24rem'});
    $(".acetylContainer").css("z-index","auto");

    $('#acetylFloatContainerBtn').click(function(){
      $(this).removeClass('active');
      $('#acetyl-legend-after').addClass('active');

      $('.acetylContainer').css({right:'0px'});
      $('.acetylContainer').css({width:'24rem'});
      $(".acetylContainer").css("z-index","auto");
      acetylLayer();
    });

    $('#acetylFloatContainerRemoveBtn').click(function(){
      $('#acetylFloatContainer').empty();
      $('.acetylContainer').css({width:'0px'});
      $('.acetylContainer').css({right:'5rem'});
      $(".acetylContainer").css("z-index","999");
      $('#acetylFloatContainerBtn').addClass('active');
      $('#acetyl-legend-after').removeClass('active');
    });

    var acetylAllData = []
    var acetylTmp = allData
    
    $.each(acetylTmp,function(n,v){
      var tmp = v.split(",");
      if(n==0){
        acetylAllData.push(v)
      }
      
      if(tmp[0] == 'ACETYL'){
        acetylAllData.push(v)
      }
    });

    let acetyl_seqPateint = acetylAllData[0].trim().split(",").slice(4);

    let acetyl_rows = acetylAllData.slice(1).map((row) => row.trim().split(","));
    acetyl_rows.map((row) => {
      acetyl_rowHeader.push(row[1]);
      acetyl_link.push(row[1].split('_')[0])
    });
    acetyl_rows.map((row) => {
      acetyl_matrix.push(row.slice(4))
    });

    data = metaArray;
    acetyl_rows = data.map((row) => row.trim().split(","));
    acetyl_rows = dataToArray(acetyl_rows);
    var tempRows = acetyl_rows.slice(1)
    tempRows = tempRows.filter((row) => acetyl_seqPateint.includes(row[0]));
    acetyl_rows = acetyl_rows.slice(0, 1)
    tempRows.forEach(element => acetyl_rows.push(element));
    acetyl_rows = dataToArray(acetyl_rows)
    var patientHeader = []
    acetyl_rows.map((row) => {
      patientHeader.push(row[0])
      acetyl_patientData.push(row.slice(1))
    });
    for (let i = 0; i < patientHeader.length; i++) {
      acetyl_metaData.push({
        name: patientHeader[i],
        array: acetyl_patientData[i]
      })
    }

    drawAcetylHeatMap();

    
    function dataToArray(array) {
      const rows = array.length;
      const cols = array[0].length;
      const transposed = [];
      for (let col = 0; col < cols; col++) {
        const newRow = [];
        for (let row = 0; row < rows; row++) {
          newRow.push(array[row][col]);
        }
        transposed.push(newRow);
      }
      return transposed;
    }
    
    //draw
    function drawAcetylHeatMap() {
      let json = {
        rows: acetyl_rowHeader.length,
        columns: acetyl_patientData[0].length,
        seriesArrays: [acetyl_matrix],
        seriesDataTypes: ["Float32"],
        seriesNames: ["Acetylsite"],
        rowMetadataModel: {
          vectors: [
            {
              name: "Acetylsite",
              array: acetyl_rowHeader,
            },
            {
              name: "Link",
              array: acetyl_link,
            },
          ],
        },
        columnMetadataModel: {
          vectors: acetyl_metaData
        },
      };

      acetylsiteMorpheus=new morpheus.HeatMap({
        el: $('#aceHeatmapDiv'),
        dataset: morpheus.Dataset.fromJSON(json),
        colorScheme: {
          type: 'fixed',
        },
      });

      hideSpinner('acetylsiteContent');
    }
    
    $('#aceHeatmapDiv').mouseup(function(event){
      if(event.currentTarget.className == 'morpheus'){
        if (acetylsiteMorpheus.selectedRowTrackName == 'Link' && ((event.button == 0) || (event.which == 1))) {
          var index = acetylsiteMorpheus.project.hoverRowIndex
          var target = acetyl_link[index]
          window.open('https://www.uniprot.org/uniprotkb/'+target+'/entry', '_blank');          
        }
        acetylsiteMorpheus.selectedRowTrackName = ''
      }
      
    });

    setTimeout(function(){
      acetylLayer();
    },1000);

    function acetylLayer(){
   
      var colorMap = acetylsiteMorpheus.project.columnColorModel.vectorNameToColorMap.map;
      var htmlStr="<table style='font-size: 11px; border-style: solid;border-width:1px;border-color: #e5efe9;'><tr>";
      var substr="";
      var i = 1;
      $.map(colorMap, function(k, v){
          if(k.key !="Sample.ID"){
            htmlStr += "<td style='text-align: center;'>"+k.key+"</td>";
            var newArr = $.map(k.value,function(key,value){return key});
            var subArr = $.map(newArr[0],function(key,value){return key});
            substr += "<td style='height: fit-content;'><div style='height: 5px;'></div><table border='1px solid #ccc' cellspacing='0' cellpadding='0' style='margin: auto;font-size: 11px;'>";
            $.map(subArr,function(key,value){
              substr += "<tr><td bgcolor='"+key.value+"' height='15' width='15'></td>"+
                "<td>"+key.key+"</td></tr>";
            });
            substr += "</table><div style='height: 5px;'></div></td>";
            if(i%1==0){
              htmlStr += substr;
              htmlStr +="</tr><tr>";
              substr = "";
            }
            i++;
          }
          
      });
      htmlStr += substr;
      htmlStr += "</tr><tr></table>";

      $('#acetylFloatContainer').append(htmlStr);

  }


  </script>